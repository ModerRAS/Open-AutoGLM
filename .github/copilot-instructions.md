# Copilot Instructions for Open-AutoGLM

- **Purpose**: Vision-language phone agent that drives Android devices over ADB; Rust rewrite of Open-AutoGLM with optional dual-loop (planner + executor) orchestration.
- **Key modules**: `src/agent/phone_agent.rs` single-loop driver; `src/agent/dual_loop.rs` scheduler owning planner/executor; `src/actions/handler.rs` validates and executes model actions; `src/model/client.rs` OpenAI-compatible client with retries/stream parsing; `src/settings.rs` persisted app config shared by CLI/GUI.
- **Action protocol**: Model must emit `finish` or `do` actions (see `parse_action` usage in `PhoneAgent::execute_step`). `ActionHandler` supports `Launch`, `Tap`, `Type/Type_Name`, `Swipe`, `Back`, `Home`, `Double Tap`, `Long Press`, `Wait`, `Take_over`, `Note`, `Call_API`, `Interact`. Unknown/malformed actions become user-facing errors—keep action keys exact.
- **Coordinate systems**: `CoordinateSystem::Relative` expects 0-999 per axis → scaled to screen; `Absolute` expects pixel coords multiplied by scale_x/scale_y (default 1.61). Validation happens in `ActionHandler::convert_coordinates`; clamp/guard against out-of-bounds to avoid user-cancellable errors. Use `AgentConfig::relative()` or `.with_absolute_coordinates()` helpers instead of manual fields.
- **System prompts**: `AgentConfig::get_system_prompt*` chooses prompt variant based on lang + coordinate system; absolute mode includes screen resolution. Keep lang codes `cn|en`; use `get_system_prompt_with_resolution` when width/height known.
- **Model client**: `ModelClient::request` posts to `{base_url}/chat/completions`, merges `extra_body.skip_special_tokens=false`, disables streaming (`stream=false`), but can parse concatenated SSE-style chunks if backend streams anyway. Retries on network/5xx/429 with `max_retries`/`retry_delay_secs`; parse errors are non-retryable. Preserve content extraction paths when modifying.
- **State & context**: `PhoneAgent` keeps `context: Vec<Value>` of messages; first step injects system prompt + base64 screenshot + screen info; subsequent steps append screen info and optional injected prompts. `step_count` enforced against `max_steps`.
- **Dual-loop behavior**: `DualLoopRunner::run` spawns planner/executor loops; priority order is user input → control commands → executor tick → planner tick. Planner owns executor and reacts immediately to executor feedback. Use `DualLoopConfig` intervals (default 2000ms planner / 500ms executor) and `auto_start`. For new controls, respect `ControlCommand` handling and `running/paused` atomic flags.
- **Persistence & config**: `AppSettings` stored via `directories::ProjectDirs` at `%APPDATA%/moderras/phone-agent/config/settings.json` (Windows). `cli` merges file + env overrides (e.g., `MODEL_BASE_URL`, `COORDINATE_SYSTEM`, `DUAL_LOOP_MODE`, planner-specific vars). Backfill defaults for new fields on load—preserve this behavior when adding fields.
- **CLI workflows**: `cargo run --bin phone-agent -- config` launches interactive wizard (shared with GUI). Normal run: `cargo run --release --bin phone-agent -- "<task>"`. Dual-loop mode enable via `DUAL_LOOP_MODE=true` (planner model uses DeepSeek defaults). Calibration runs: `cargo run --release --bin phone-agent -- --calibrate` (simple) or `--calibrate-complex`; env `ENABLE_CALIBRATION=true` to auto-run.
- **GUI**: `phone-agent-gui` uses `iced`; entry in `src/bin/gui.rs` embeds `NotoSansSC` font. Use `PhoneAgentApp` in `src/gui/` for UI changes; keep window size 900x700 unless intentionally altered.
- **ADB/Device interactions**: `ActionHandler` routes to `adb::*` helpers (`tap`, `swipe`, `launch_app`, keyboard setup). Confirmation/takeover callbacks default to no-op behaviors—provide hooks when embedding.
- **Testing/examples**: `examples/basic_usage.rs` and `examples/demo_thinking.rs` runnable via `cargo run --example <name>`. Prefer `cargo build --release` for deployable binaries.
- **Localization & prompts**: Prompts/messages keyed by `lang` using `config/i18n.rs` and `config/prompts.rs`; keep new strings dual-language when feasible.
- **Data files**: Prompt memory persists to `prompt_memory.json` (path configurable). When adding learned-memory features, keep consolidation logic compatible with planner expectations (see README dual-loop section).
- **Logging/telemetry**: CLI initializes `tracing_subscriber::fmt`; dual-loop logs significant executor states. Do not remove logging around executor failures/stuck detection.
- **When extending actions or planner logic**: maintain error messages user-friendly (Chinese/English friendly), preserve retry-on-parse-fail pattern in `PhoneAgent::execute_step` (returns `_metadata: error` to prompt model retry), and update README tables if behaviors change.

Feedback: If any section is unclear or missing for your workflow, tell me what to adjust.